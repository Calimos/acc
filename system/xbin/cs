#!/system/bin/sh

# Magic Charging Switch (cs)
# VR25 @ XDA Developers

echo


# Toolbox

c_info() { echo "$(echo "$i" | cut -d/ -f6)	$(cat "$i")" \
	| grep -vE 'NAME|STATUS|PRESENT|HEALTH|COUNTER' \
	| grep -vEo 'uevent| |POWER_SUPPLY_' \
	| sed s/CAPACITY/'LEVEL'/ \
	| sed /'LEVEL='/s/$/'%'/ \
	| sed s/'_NOW'/''/ \
	| sed s/RGE/RGING/
}

c_loop() { echo
	echo "(i) Desired charge % reached"
	sOFF
	rm -f /data/system/batterystats.bin 2>/dev/null
	rm -f $st
	echo $c_OFF > $s
	if echo "$p0" | grep -q [0-9]; then
		echo "- Maintaining $p0-$p%..."
		. $i
		until [ "$POWER_SUPPLY_CAPACITY" -lt "$p0" ]; do
			. $i
			sleep 900
		done
		cs
		exit 0
	else
		echo "- Press RETURN to re-enable charging & exit"
		read INPUT
		echo $c_ON > $s
		exit 0
	fi
}

ctrl_file() {
	if model 'Pixel|HTC'; then switch charger_control 0 1
	elif model 'Galaxy Note'; then switch store_mode 0 1
	elif ! model 'Galaxy Note' && model Samsung; then switch batt_slate_mode 0 1
	elif model Huawei; then switch s=/sys/class/hw_power/charger/charge_data/enable_charger
	elif model 'Amazon Fire'; then switch "/device/Charging_Enable"
	elif model 'Nexus 4'; then switch s=/sys/module/pm8921_charger/parameters/disabled 0 1
	elif model 'Nexus 10'; then switch "s=/sys/devices/virtual/power_supply/manta-battery/charge_enabled"
	elif model 'Nvidia Shield'; then switch "s=/sys/devices/platform/7000c400.i2c/i2c-1/1-006b/charging_state" enabled disabled
	elif model 'Xiaomi Mi6'; then switch input_suspend 0 1
	elif model 'Xiaomi MiPad 2'; then switch s=/sys/class/power_supply/bq2589x_charger/enable_charging
	elif model 'Nexus 5'; then switch s=/sys/class/power_supply/ac/charging_enabled
	elif model 'Teclast X98 Air III'; then switch s=/sys/class/power_supply/dollar_cove_charger/present
	elif model 'Nexus 9'; then switch "s=/sys/devices/platform/tegra12-i2c.0/i2c-0/0-006b/charging_state" enabled disabled
	elif model 'Galaxy Nexus'; then switch charge_enabled
	elif model 'Xiaomi Redmi Note 2'; then switch s=/sys/devices/platform/battery/ChargerEnable
	fi

	[ ! -f "$s" ] && switch battery_charging_enabled
	[ ! -f "$s" ] && switch charging_enabled
	if [ ! -f "$s" ]; then echo "(!) cs: Unsupported device"; exit 1; fi
}

exxit() {
	echo "(!) cs: Invalid option/argument"
	cs --help
	exit 1
}

model() { getprop | grep -Eiq "$1"; }
sON() { echo "- S/ON --> $(date)"; }
sOFF() { echo "- S/OFF --> $(date)"; }

switch() { echo "$1" | grep -q 's=' && "$1" \
	|| s=/sys/class/power_supply/battery/"$1"
	if [ "$2" ]; then
		c_ON=$2
		c_OFF=$3
	else
		c_ON=1
		c_OFF=0
	fi
}


# Environment
i=/sys/class/power_supply/battery/uevent
h=/data/.cs_settings
st=/data/.cs_sON
sON > $st


if [ "$1" = '--help' ]; then
	cat <<eot
Magic Charging Switch (cs)

Stops charging at a set % level below 100 to extend battery lifespan. Battery stats are cleared automatically.

Note: your terminal emulator must be excluded from battery optimization &/or Doze for cs to work properly.


Usage:

cs -i --> show battery info

cs % % --> pause charging at first %; resume charging if battery drops below second % (optional)

cs -d [timeout (optional)] --> disable charging

cs -e [timeout (optional)] --> enable charging

just "cs" --> run cs with previous settings

cs --help --> self-explanatory

cs debug --> generate 3 debugging zips in /data/_cs_debug (one per run). Upload these (manually) to the official XDA thread (link -- README)
- Run
-- While charging (USB)
-- While charging (AC)
-- While unplugged (not charging)


Tips

"cs 80" --> stop charging at 80%.

"cs 80 20" --> pause charging at 80%; resume if battery drops below 20%.

"-d" & "-e" options can take a "timeout" argument to automatically enable & disable charging, respectively (i.e., "cs -d 30m" --> keep charging disabled for 30 minutes, "cs -e 1h" --> charge for 1 hour).

"cs -e 120 && cs -d 30m && cs -e 1h" --> charge for 120 seconds, pause for 30 minutes, then charge again for 1h.

"cs -e 30m && cs -d 30m && cs 90" --> charge for 30 minutes, pause for 30 minutes, then charge again, but this time until battery level is greater or equal to 90%.
eot
echo
exit 0


# Disable charging
elif [ "$1" = '-d' ]; then
	ctrl_file
	echo $c_OFF > $s
	if [ "$2" ]; then 
		if echo "$2" | grep -Eq '[a-z]{1}'; then
			echo "(i) Charging disabled for $2"
			sOFF
			if echo "$2" | grep -q 'm'; then sleep $(( 60 * $(echo $2 | grep -ov 'm') ))
			elif echo "$2" | grep -q 'h'; then sleep $(( 3600 * $(echo $2 | grep -ov 'h') ))
			else exxit; fi
		else
			echo "(i) Charging disabled for $2s"
			sOFF
			sleep $2; fi
		echo
		echo '(i) Timeount reached'
		echo $c_ON > $s
		echo '- Charging re-enabled'
		sON
	else echo '(i) Charging disabled'; sOFF; fi
	echo
	exit 0
	

# Enable charging	
elif [ "$1" = '-e' ]; then
	ctrl_file
	echo $c_ON > $s
	if [ "$2" ]; then 
		if echo "$2" | grep -Eq '[a-z]{1}'; then
			echo "(i) Charging enabled for $2"
			sON
			if echo "$2" | grep -q 'm'; then sleep $(( 60 * $(echo $2 | grep -ov 'm') ))
			elif echo "$2" | grep -q 'h'; then sleep $(( 3600 * $(echo $2 | grep -ov 'h') ))
			else exxit; fi
		else
			echo "(i) Charging enabled for $2s"
			sON
			sleep $2; fi
		echo
		echo '(i) Timeount reached'
		echo $c_OFF > $s
		echo '- Charging disabled'
		sOFF
	else echo '(i) Charging enabled'; sON; fi
	echo
	exit 0


# Battery info
elif [ "$1" = '-i' ]; then
	echo 'Battery Info'
	echo "$(echo "$i" | cut -d/ -f6)	$(cat "$i")" \
		| grep -Ev 'NAME|PRESENT' \
		| grep -vEo 'uevent| |POWER_SUPPLY_' \
		| sed s/CAPACITY/LEVEL/ \
		| sed /'LEVEL='/s/$/'%'/ \
		| sed s/'_NOW'/''/ \
		| sed s/RGE/RGING/
	echo
	exit 0


# Run with previous settings
elif [ -z "$1" ]; then
	ctrl_file
	echo $c_ON > $s
	if [ ! -f "$h" ]; then clear; cs --help; exit 0; fi
	. $h
	. $i
	
	while [ "$POWER_SUPPLY_CAPACITY" -lt "$p" ]; do
		clear
		. $i
		echo "Charging to $p%..."
		cat $st
		echo
		c_info
		echo
		echo "(i) Press CTRL+C to abort"
		sleep 60
	done
	c_loop


# Debugging
elif [ "$1" = "debug" ]; then
	mkdir /data/_cs
	mkdir /data/_cs_debug 2>/dev/null
	cd /sys/class/power_supply/battery
	for f in $(ls -1); do
		[ -f $f ] && cp "$f" /data/_cs
	done
	cp /system/build.prop /data/_cs
	cd /data/_cs

	if [ -f /data/cs_debug.zip ]; then
		zip -9 /data/cs_debug_2.zip *
		echo
		echo "(i) $(zip -T /data/cs_debug_2.zip)"
		rm -rf /data/_cs
		run_step="2/3"
	elif [ -f /data/cs_debug_2.zip ]; then
		zip -9 /data/cs_debug_3.zip *
		echo
		echo "(i) $(zip -T /data/cs_debug_3.zip)"
		rm -rf /data/_cs
		run_step="3/3"
	else
		zip -9 /data/cs_debug.zip *
		echo
		echo "(i) $(zip -T /data/cs_debug.zip)"
		rm -rf /data/_cs
		run_step="1/3"
	fi

	echo
	[ "$run_step" = "3/3" ] && echo Done \
		|| echo "Step $run_step"
 	exit 0
 

elif echo "$1" | grep -q [0-9]; then :
else exxit; fi


# Run with all parameters (initial setup)
ctrl_file
echo $c_ON > $s
. $i
while [ "$POWER_SUPPLY_CAPACITY" -lt "$1" ]; do
	clear
	. $i
	echo "Charging to $1%..."
	cat $st
	echo
	c_info
	echo
	echo "(i) Press CTRL+C to abort"
	sleep 60
done

echo "p=$1" > $h
echo "p0=$2" >> $h
. $h
c_loop
